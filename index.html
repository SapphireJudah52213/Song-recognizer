<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Music Recognizer</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #0d1117;
    color: white;
    text-align: center;
}
h1 { margin-top: 20px; }
button {
    padding: 12px 22px;
    font-size: 18px;
    margin: 10px;
}
#status {
    font-size: 20px;
    margin: 15px;
}
canvas {
    display: block;
    margin: 10px auto;
    background: #111;
    border-radius: 8px;
}
#meter {
    width: 80%;
    height: 15px;
    background: #333;
    margin: auto;
    border-radius: 10px;
    overflow: hidden;
}
#meterFill {
    height: 100%;
    width: 0%;
    background: lime;
}
</style>
</head>

<body>

<h1>Music Recognizer</h1>
<p>Detects <strong>Happy Birthday</strong> or <strong>Indiscretions – Brand X</strong></p>

<button onclick="start()">Start Listening</button>
<div id="status">Idle</div>

<div id="meter"><div id="meterFill"></div></div>
<canvas id="graph" width="320" height="130"></canvas>

<script>
let audioCtx, analyser, mic;
let buffer = new Float32Array(2048);
let pitches = [];
let locked = false;

const canvas = document.getElementById("graph");
const ctx = canvas.getContext("2d");

/* === SONG SIGNATURES === */

/* Happy Birthday – absolute pitch tolerance */
const HAPPY = [
  264,264,297,264,352,330,
  264,264,297,264,396,352,
  264,264,528,440,352,330,297,
  466,466,440,352,396,352
];

/* Indiscretions – Brand X
   Relative pitch contour (ratios)
   Captures the opening riff movement */
const BRANDX = [
  1.00, 1.18, 0.92, 1.34, 1.12, 0.88, 1.26
];

function start() {
    navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
        audioCtx = new AudioContext();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;
        mic = audioCtx.createMediaStreamSource(stream);
        mic.connect(analyser);
        pitches = [];
        locked = false;
        document.getElementById("status").textContent = "Listening…";
        loop();
    });
}

function loop() {
    analyser.getFloatTimeDomainData(buffer);
    let pitch = detectPitch(buffer, audioCtx.sampleRate);
    let vol = rms(buffer);

    document.getElementById("meterFill").style.width =
        Math.min(vol * 300, 100) + "%";

    if (pitch > 0) {
        pitches.push(pitch);
        draw(pitch);
        if (pitches.length > 260 && !locked) analyze();
    }

    requestAnimationFrame(loop);
}

function rms(buf) {
    let s = 0;
    for (let i of buf) s += i*i;
    return Math.sqrt(s / buf.length);
}

function detectPitch(buf, rate) {
    let best = 0, offset = -1;
    for (let o = 20; o < 1000; o++) {
        let c = 0;
        for (let i = 0; i < buf.length - o; i++)
            c += buf[i] * buf[i + o];
        if (c > best) {
            best = c;
            offset = o;
        }
    }
    return offset > 0 ? rate / offset : -1;
}

function draw(freq) {
    ctx.fillStyle = "#111";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = "cyan";
    let y = canvas.height - Math.min(freq / 5, canvas.height);
    ctx.fillRect(pitches.length % canvas.width, y, 2, 2);
}

function analyze() {
    let hb = matchHappy();
    let bx = matchBrandX();

    if (hb > 0.6) {
        locked = true;
        document.getElementById("status").textContent =
            "Detected: Happy Birthday";
    }
    else if (bx > 0.55) {
        locked = true;
        document.getElementById("status").textContent =
            "Detected: Indiscretions – Brand X";
    }
    else {
        pitches = [];
    }
}

function matchHappy() {
    let hits = 0;
    for (let n of HAPPY) {
        if (pitches.find(p => Math.abs(p - n) < 15)) hits++;
    }
    return hits / HAPPY.length;
}

function matchBrandX() {
    let ratios = [];
    for (let i = 1; i < pitches.length; i++) {
        ratios.push(pitches[i] / pitches[i-1]);
    }

    let score = 0;
    for (let r of BRANDX) {
        if (ratios.find(x => Math.abs(x - r) < 0.08)) score++;
    }
    return score / BRANDX.length;
}
</script>

</body>
</html>
