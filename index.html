<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-Song Recognizer</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#0d1117; color:white; text-align:center; }
button{ padding:12px; font-size:18px; margin:10px; }
#status{ font-size:20px; margin:15px; }
canvas{ display:block; margin:10px auto; background:#111; border-radius:8px; }
#meter{ width:80%; height:15px; background:#333; margin:auto; border-radius:10px; overflow:hidden; }
#meterFill{height:100%; width:0%; background:lime;}
</style>
</head>
<body>

<h1>Multi-Song Recognizer</h1>
<p>Sing/play Lindsey Stirling radio songs</p>

<button onclick="start()">Start</button>
<div id="status">Idle</div>
<div id="meter"><div id="meterFill"></div></div>
<canvas id="graph" width="320" height="130"></canvas>

<script>
let audioCtx, analyser, buffer = new Float32Array(2048);
let pitches = [], locked=false;
const canvas=document.getElementById("graph"),ctx=canvas.getContext("2d");

// Song signature definitions (simple pitch motifs)
const SONGS = [
  { name:"Happy Birthday", pattern:[264,264,297,264,352,330] },
  { name:"Crystallize", pattern:[264,297,330,352,396] },       // example motif
  { name:"Shatter Me", pattern:[330,352,396,352,330] },
  { name:"The Arena", pattern:[297,352,396,440,466] },
  { name:"Something Wild", pattern:[264,297,352,396,440] },
  { name:"Beyond the Veil", pattern:[352,396,440,396,352] },
  { name:"Elements", pattern:[264,330,396,466,528] },
  { name:"Hold My Heart", pattern:[297,352,440,352,297] },
  { name:"Roundtable Rival", pattern:[264,297,330,352,396] }
];

function start() {
  navigator.mediaDevices.getUserMedia({audio:true})
  .then(stream=>{
    audioCtx=new AudioContext();
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=2048;
    analyser.createMediaStreamSource(stream).connect(analyser);
    pitches=[]; locked=false;
    document.getElementById("status").textContent="Listeningâ€¦";
    loop();
  });
}

function loop(){
  analyser.getFloatTimeDomainData(buffer);
  let freq = detectPitch(buffer,audioCtx.sampleRate);
  let vol = rms(buffer);
  document.getElementById("meterFill").style.width=Math.min(vol*300,100)+"%";
  if(freq>0){ pitches.push(freq); draw(freq); if(pitches.length>250 && !locked) analyze(); }
  requestAnimationFrame(loop);
}

function rms(buf){ let s=0;for(let i of buf)s+=i*i; return Math.sqrt(s/buf.length); }

function detectPitch(buf,rate){
  let best=0,off=-1;
  for(let o=20;o<1000;o++){
    let corr=0;
    for(let i=0;i<buf.length-o;i++)corr+=buf[i]*buf[i+o];
    if(corr>best){best=corr;off=o;}
  }
  return off>0?rate/off:-1;
}

function draw(freq){
  ctx.fillStyle="#111";ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="cyan";let y=canvas.height-Math.min(freq/5,canvas.height);
  ctx.fillRect(pitches.length%canvas.width,y,2,2);
}

function analyze(){
  let results=[];
  for(let s of SONGS){
    let hits=0;
    for(let n of s.pattern)
      if(pitches.find(p=>Math.abs(p-n)<15))hits++;
    results.push({song:s.name,score: hits/s.pattern.length});
  }
  results.sort((a,b)=>b.score-a.score);
  let best=results[0];
  if(best.score>0.5){
    locked=true;
    document.getElementById("status").textContent = "Detected: "+best.song;
  } else {
    pitches=[];
  }
}
</script>

</body>
</html>
